// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/dts-v1/;

/* 引用 CPU 定义 (sun8i-t113s.dtsi) */
#include "sun8i-t113s.dtsi"

/* 
 * 宏定义：GPIO & LED
 * 手动定义以避免头文件依赖
 */
#ifndef GPIO_ACTIVE_HIGH
#define GPIO_ACTIVE_HIGH 0
#endif
#ifndef GPIO_ACTIVE_LOW
#define GPIO_ACTIVE_LOW 1
#endif
#ifndef LED_COLOR_ID_GREEN
#define LED_COLOR_ID_GREEN 2
#endif
#ifndef LED_FUNCTION_STATUS
#define LED_FUNCTION_STATUS "status"
#endif

/ {
	model = "Tronlong TLT113-MiniEVM (NAND/HDMI)";
	compatible = "tronlong,tlt113-minievm", "allwinner,sun8i-t113s", "allwinner,sun8i";

	aliases {
		serial0 = &uart0;
		ethernet0 = &emac;
		ethernet1 = &usbether;
		spi0 = &spi0;
	};

	chosen {
		stdout-path = "serial0:115200n8";
	};

	/* 定义一个通用的 3.3V 电源，替代不存在的 DCDC1 */
	reg_vcc3v3: vcc3v3 {
		compatible = "regulator-fixed";
		regulator-name = "vcc3v3";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		regulator-always-on;
	};

	/* 板载 USB VBUS 电源 (MiniEVM: PB12) */
	reg_usb1_vbus: usb1-vbus {
		compatible = "regulator-fixed";
		regulator-name = "usb1-vbus";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		regulator-enable-ramp-delay = <1000>;
		gpio = <&pio 1 12 GPIO_ACTIVE_HIGH>; /* PB12 */
		enable-active-high;
		regulator-always-on;
	};

	/* HDMI 虚拟接口 */
	hdmi_connector: connector {
		compatible = "hdmi-connector";
		type = "a";
		ddc-i2c-bus = <&i2c0>;
		port {
			hdmi_con_in: endpoint {
				remote-endpoint = <&lt8912_out>;
			};
		};
	};

	leds {
		compatible = "gpio-leds";
		led-0 {
			function = LED_FUNCTION_STATUS;
			color = <LED_COLOR_ID_GREEN>;
			label = "tlt113:green:status";
			gpios = <&pio 2 0 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "heartbeat";
		};
	};
};

&pio {
	/* 补全 MMC0 引脚定义: PF0-PF5 */
	mmc0_pins: mmc0-pins {
		pins = "PF0", "PF1", "PF2", "PF3", "PF4", "PF5";
		function = "mmc0";
		drive-strength = <30>;
		bias-pull-up;
	};

	mmc0_cd_pin: mmc0-cd-pin {
		pins = "PF6";
		function = "gpio_in";
		bias-pull-up;
	};

	uart0_pg_pins: uart0-pg-pins {
		pins = "PG17", "PG18";
		function = "uart0";
	};

	emac_rgmii_pins: emac-rgmii-pins {
		pins = "PG0", "PG1", "PG2", "PG3", "PG4", "PG5", "PG6",
		       "PG7", "PG8", "PG9", "PG10", "PG12",
		       "PG14", "PG15";
		function = "emac";
		drive-strength = <40>;
	};
    
	i2c0_pins: i2c0-pins {
		pins = "PB10", "PB11";
		function = "twi0";
	};

	i2c2_pins: i2c2-pins {
		pins = "PE12", "PE13";
		function = "twi2";
	};

	spi0_pins: spi0-pins {
		pins = "PC2", "PC4", "PC5", "PC6", "PC7"; 
		function = "spi0";
	};
	spi0_cs0_pin: spi0-cs0-pin {
		pins = "PC3";
		function = "spi0";
	};
};

&uart0 {
	pinctrl-names = "default";
	pinctrl-0 = <&uart0_pg_pins>;
	status = "okay";
};

&mmc0 {
	pinctrl-names = "default";
	pinctrl-0 = <&mmc0_pins>;
	vmmc-supply = <&reg_vcc3v3>;
	bus-width = <4>;
	cd-gpios = <&pio 5 6 GPIO_ACTIVE_LOW>;
	status = "okay";
};

/* 禁用 eMMC */
&mmc2 { status = "disabled"; };

&spi0 {
	pinctrl-names = "default";
	pinctrl-0 = <&spi0_pins>, <&spi0_cs0_pin>;
	status = "okay";
	flash@0 {
		compatible = "spi-nand";
		reg = <0>;
		spi-max-frequency = <40000000>;
		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;
			partition@0 {
				label = "u-boot";
				reg = <0x000000 0x200000>;
				read-only;
			};
			partition@200000 {
				label = "ubi";
				reg = <0x200000 0xfe00000>;
			};
		};
	};
};

&emac {
	pinctrl-names = "default";
	pinctrl-0 = <&emac_rgmii_pins>;
	phy-mode = "rgmii-id"; 
	phy-handle = <&ext_rgmii_phy>;
	status = "okay";
	mdio {
		compatible = "snps,dwmac-mdio";
		#address-cells = <1>;
		#size-cells = <0>;
		ext_rgmii_phy: ethernet-phy@0 {
			compatible = "ethernet-phy-ieee802.3-c22";
			reg = <0>;
            reset-gpios = <&pio 6 13 GPIO_ACTIVE_LOW>;
            reset-assert-us = <10000>;
            reset-deassert-us = <150000>;
			motorcomm,clk-out-frequency-hz = <125000000>;
            motorcomm,keep-pll-enabled;
            motorcomm,auto-sleep-disabled;
		};
	};
};

&i2c0 {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&i2c0_pins>;
};

&i2c2 {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&i2c2_pins>;
	lt8912@48 {
		compatible = "lontium,lt8912b";
		reg = <0x48>;
		reset-gpios = <&pio 4 11 GPIO_ACTIVE_LOW>; 
		ports {
			#address-cells = <1>;
			#size-cells = <0>;
			port@0 {
				reg = <0>;
				lt8912_in: endpoint {
					remote-endpoint = <&dsi_out_bridge>;
				};
			};
			port@1 {
				reg = <1>;
				lt8912_out: endpoint {
					remote-endpoint = <&hdmi_con_in>;
				};
			};
		};
	};
};

&display_engine { status = "okay"; };
&tcon_lcd0 { status = "okay"; };
&dsi {
	status = "okay";
	#address-cells = <1>;
	#size-cells = <0>;
	ports {
		port@0 {
			reg = <0>;
			dsi_out_bridge: endpoint {
				remote-endpoint = <&lt8912_in>;
			};
		};
	};
};
&dphy { status = "okay"; };

&usb_otg { dr_mode = "host"; status = "okay"; };
&usbphy { usb1_vbus-supply = <&reg_usb1_vbus>; status = "okay"; };
&ehci1 { status = "okay"; };
&ohci1 { status = "okay"; };
&ehci0 { status = "okay"; };
&ohci0 { status = "okay"; };
