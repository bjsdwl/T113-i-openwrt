/dts-v1/;

/ {
    model = "Tronlong TLT113-MiniEVM (OpenWrt)";
    compatible = "tronlong,tlt113-minievm", "allwinner,sun8i-t113s", "allwinner,sun8i";

    #address-cells = <1>;
    #size-cells = <1>;

    interrupt-parent = <&gic>;

    aliases {
        serial0 = &uart0;
        mmc0 = &mmc0;
    };

    chosen {
        stdout-path = "serial0:115200n8";
        /* 预设启动参数，配合 clk_ignore_unused 和 initcall_debug 深度调试 */
        bootargs = "console=ttyS0,115200 earlycon=uart8250,mmio32,0x02500000 root=/dev/mmcblk0p5 rootwait panic=10 clk_ignore_unused initcall_debug=1";
    };

    /* 架构定时器：解决内核启动挂起的“心脏” */
    timer {
        compatible = "arm,armv7-timer";
        interrupts = <1 13 0xf08>, /* GIC_PPI 13: Secure Phys */
                     <1 14 0xf08>, /* GIC_PPI 14: Non-secure Phys */
                     <1 11 0xf08>, /* GIC_PPI 11: Virtual */
                     <1 10 0xf08>; /* GIC_PPI 10: Hypervisor */
        interrupt-parent = <&gic>;
        /* 关键：强制指定频率，防范 U-Boot 未初始化 CNTFRQ 寄存器 */
        clock-frequency = <24000000>;
    };

    /* 物理布局避障：井水不犯河水 */
    reserved-memory {
        #address-cells = <1>;
        #size-cells = <1>;
        ranges;

        /* 1. OP-TEE 保留区 (U-Boot 已确认地址) */
        optee_reserve: optee@41c00000 {
            reg = <0x41c00000 0x1000000>;
            no-map;
        };

        /* 2. 官方 U-Boot 动态注入的显示保留区 (经日志诊断确认) */
        /* 提前在静态 DTS 中声明，防止内核 Page Table 冲突 */
        display_reserve: display@4c8dd000 {
            reg = <0x4c8dd000 0x7e9000>;
            no-map;
        };
    };

    cpus {
        #address-cells = <1>;
        #size-cells = <0>;

        cpu0: cpu@0 {
            compatible = "arm,cortex-a7";
            device_type = "cpu";
            reg = <0>;
            clocks = <&ccu 0>; /* CLK_CPUX */
        };

        cpu1: cpu@1 {
            compatible = "arm,cortex-a7";
            device_type = "cpu";
            reg = <1>;
            clocks = <&ccu 0>;
        };
    };

    /* 外部晶振定义 */
    osc24M: osc24M_clk {
        #clock-cells = <0>;
        compatible = "fixed-clock";
        clock-frequency = <24000000>;
        clock-output-names = "osc24M";
    };

    osc32k: osc32k_clk {
        #clock-cells = <0>;
        compatible = "fixed-clock";
        clock-frequency = <32768>;
        clock-output-names = "osc32k";
    };

    /* 板载固定电压源 */
    reg_vcc3v3: vcc3v3 {
        compatible = "regulator-fixed";
        regulator-name = "vcc3v3";
        regulator-min-microvolt = <3300000>;
        regulator-max-microvolt = <3300000>;
        regulator-always-on;
    };

    soc {
        compatible = "simple-bus";
        #address-cells = <1>;
        #size-cells = <1>;
        ranges;

        /* 中断控制器 GIC-400 */
        gic: interrupt-controller@3021000 {
            compatible = "arm,gic-400";
            reg = <0x03021000 0x1000>,
                  <0x03022000 0x2000>,
                  <0x03024000 0x2000>,
                  <0x03026000 0x2000>;
            interrupt-controller;
            #interrupt-cells = <3>;
            device_type = "interrupt-controller";
        };

        /* 时钟控制单元 CCU：修正为 sun8i 兼容字符串 */
        ccu: clock-controller@2001000 {
            compatible = "allwinner,sun8i-t113s-ccu";
            reg = <0x02001000 0x1000>;
            clocks = <&osc24M>, <&osc32k>;
            clock-names = "hosc", "losc";
            #clock-cells = <1>;
            #reset-cells = <1>;
        };

        /* 引脚控制器 PIO */
        pio: pinctrl@2000000 {
            compatible = "allwinner,sun8i-t113s-pinctrl";
            reg = <0x02000000 0x800>;
            interrupts = <0 14 4>, <0 15 4>;
            clocks = <&ccu 13>, <&osc24M>, <&osc32k>;
            clock-names = "apb", "hosc", "losc";
            gpio-controller;
            #gpio-cells = <3>;
            interrupt-controller;
            #interrupt-cells = <3>;

            uart0_pg_pins: uart0-pg-pins {
                pins = "PG17", "PG18";
                function = "uart0";
            };

            mmc0_pins: mmc0-pins {
                pins = "PF0", "PF1", "PF2", "PF3", "PF4", "PF5";
                function = "mmc0";
                drive-strength = <30>;
                bias-pull-up;
            };
        };

        /* 调试串口 UART0 */
        uart0: serial@2500000 {
            compatible = "snps,dw-apb-uart";
            reg = <0x02500000 0x400>;
            interrupts = <0 2 4>;
            reg-shift = <2>;
            reg-io-width = <4>;
            clocks = <&ccu 62>; /* CLK_BUS_UART0 */
            resets = <&ccu 18>; /* RST_BUS_UART0 */
            status = "okay";
            pinctrl-names = "default";
            pinctrl-0 = <&uart0_pg_pins>;
        };

        /* SD卡接口 MMC0 */
        mmc0: mmc@4020000 {
            compatible = "allwinner,sun8i-t113s-mmc";
            reg = <0x04020000 0x1000>;
            interrupts = <0 39 4>;
            clocks = <&ccu 59>, <&ccu 56>; /* CLK_BUS_MMC0, CLK_MMC0 */
            clock-names = "ahb", "mmc";
            resets = <&ccu 15>; /* RST_BUS_MMC0 */
            reset-names = "ahb";
            pinctrl-names = "default";
            pinctrl-0 = <&mmc0_pins>;
            vmmc-supply = <&reg_vcc3v3>;
            bus-width = <4>;
            cd-gpios = <&pio 5 6 1>; /* PF6: SD卡检测 */
            status = "okay";
        };
    };
};
