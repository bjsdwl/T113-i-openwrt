// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/dts-v1/;

#include "sun8i-t113s.dtsi"
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/leds/common.h>
#include <dt-bindings/interrupt-controller/irq.h>

/ {
	model = "Tronlong TLT113-MiniEVM (NAND/HDMI)";
	compatible = "tronlong,tlt113-minievm", "allwinner,sun8i-t113s", "allwinner,sun8i";

	aliases {
		serial0 = &uart0;
		ethernet0 = &emac;
		ethernet1 = &usbether;
		spi0 = &spi0;
	};

	chosen {
		stdout-path = "serial0:115200n8";
	};

	/* 定义 HDMI 物理接口 */
	hdmi_connector: connector {
		compatible = "hdmi-connector";
		type = "a";
		/* 关键：使用 I2C0 读取显示器的 EDID 信息 */
		ddc-i2c-bus = <&i2c0>;

		port {
			hdmi_con_in: endpoint {
				remote-endpoint = <&lt8912_out>;
			};
		};
	};

	/* USB 供电 (MiniEVM PB12) */
	reg_usb1_vbus: usb1-vbus {
		compatible = "regulator-fixed";
		regulator-name = "usb1-vbus";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		regulator-enable-ramp-delay = <1000>;
		gpio = <&pio 1 12 GPIO_ACTIVE_HIGH>; /* PB12 */
		enable-active-high;
		regulator-always-on;
	};

	leds {
		compatible = "gpio-leds";
		led-0 {
			function = LED_FUNCTION_STATUS;
			color = <LED_COLOR_ID_GREEN>;
			label = "tlt113:green:status";
			gpios = <&pio 2 0 GPIO_ACTIVE_HIGH>;
			linux,default-trigger = "heartbeat";
		};
	};
};

&pio {
	uart0_pg_pins: uart0-pg-pins {
		pins = "PG17", "PG18";
		function = "uart0";
	};

	/* 千兆 RGMII 引脚 */
	emac_rgmii_pins: emac-rgmii-pins {
		pins = "PG0", "PG1", "PG2", "PG3", "PG4", "PG5", "PG6",
		       "PG7", "PG8", "PG9", "PG10", "PG12",
		       "PG14", "PG15";
		function = "emac";
		drive-strength = <40>;
	};
    
	/* I2C0 (PB10/11) 用于 HDMI EDID */
	i2c0_pins: i2c0-pins {
		pins = "PB10", "PB11";
		function = "twi0";
	};

	/* I2C2 (PE12/13) 用于配置 LT8912B 芯片 */
	i2c2_pins: i2c2-pins {
		pins = "PE12", "PE13";
		function = "twi2";
	};

	spi0_pins: spi0-pins {
		pins = "PC2", "PC4", "PC5", "PC6", "PC7"; 
		function = "spi0";
	};
	spi0_cs0_pin: spi0-cs0-pin {
		pins = "PC3";
		function = "spi0";
	};
	
	mmc0_cd_pin: mmc0-cd-pin {
		pins = "PF6";
		function = "gpio_in";
		bias-pull-up;
	};
};

/* --- 1. 显示引擎与 DSI 配置 --- */
&display_engine {
	status = "okay";
};

&tcon_lcd0 {
	status = "okay";
};

&dsi {
	status = "okay";
	#address-cells = <1>;
	#size-cells = <0>;

	ports {
		port@0 {
			reg = <0>;
			dsi_out_bridge: endpoint {
				remote-endpoint = <&lt8912_in>;
			};
		};
	};
};

&dphy {
	status = "okay";
};

/* --- 2. I2C 配置 (LT8912B & EDID) --- */

/* I2C0: 连接 HDMI 接口的 DDC 通道 (读取显示器参数) */
&i2c0 {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&i2c0_pins>;
};

/* I2C2: 连接 LT8912B 芯片本身 (控制芯片) */
&i2c2 {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&i2c2_pins>;
	
	lt8912@48 {
		compatible = "lontium,lt8912b";
		reg = <0x48>;
		
		/* 复位引脚: PE11 (原理图 Page 10) */
		reset-gpios = <&pio 4 11 GPIO_ACTIVE_LOW>; 

		ports {
			#address-cells = <1>;
			#size-cells = <0>;

			port@0 {
				reg = <0>;
				lt8912_in: endpoint {
					remote-endpoint = <&dsi_out_bridge>;
				};
			};

			port@1 {
				reg = <1>;
				lt8912_out: endpoint {
					remote-endpoint = <&hdmi_con_in>;
				};
			};
		};
	};
};

/* --- 3. 基础外设配置 (NAND/ETH/USB) --- */

&uart0 {
	pinctrl-names = "default";
	pinctrl-0 = <&uart0_pg_pins>;
	status = "okay";
};

&mmc0 {
	pinctrl-names = "default";
	pinctrl-0 = <&mmc0_pins>;
	vmmc-supply = <&reg_dcdc1>;
	bus-width = <4>;
	cd-gpios = <&pio 5 6 GPIO_ACTIVE_LOW>;
	status = "okay";
};

&mmc2 { status = "disabled"; };

&spi0 {
	pinctrl-names = "default";
	pinctrl-0 = <&spi0_pins>, <&spi0_cs0_pin>;
	status = "okay";
	flash@0 {
		compatible = "spi-nand";
		reg = <0>;
		spi-max-frequency = <40000000>;
		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;
			partition@0 {
				label = "u-boot";
				reg = <0x000000 0x200000>;
				read-only;
			};
			partition@200000 {
				label = "ubi";
				reg = <0x200000 0xfe00000>;
			};
		};
	};
};

/* 千兆 RGMII 配置 */
&emac {
	pinctrl-names = "default";
	pinctrl-0 = <&emac_rgmii_pins>;
	phy-mode = "rgmii-id"; 
	phy-handle = <&ext_rgmii_phy>;
	status = "okay";
	mdio {
		compatible = "snps,dwmac-mdio";
		#address-cells = <1>;
		#size-cells = <0>;
		ext_rgmii_phy: ethernet-phy@0 {
			compatible = "ethernet-phy-ieee802.3-c22";
			reg = <0>;
            reset-gpios = <&pio 6 13 GPIO_ACTIVE_LOW>;
            reset-assert-us = <10000>;
            reset-deassert-us = <150000>;
			motorcomm,clk-out-frequency-hz = <125000000>;
            motorcomm,keep-pll-enabled;
            motorcomm,auto-sleep-disabled;
		};
	};
};

&usb_otg { dr_mode = "host"; status = "okay"; };
&usbphy { usb1_vbus-supply = <&reg_usb1_vbus>; status = "okay"; };
&ehci1 { status = "okay"; };
&ohci1 { status = "okay"; };
&ehci0 { status = "okay"; };
&ohci0 { status = "okay"; };
