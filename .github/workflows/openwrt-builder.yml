#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt for Tronlong T113-i (Session 5 - Final Perfection)
#

name: OpenWrt Builder

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization environment
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev u-boot-tools gdisk
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        
        # ä¸‹è½½å®˜æ–¹ mkbootimg å·¥å…· (LineageOS 18.1 ç¨³å®šç‰ˆï¼Œæ”¯æŒ v2 header)
        sudo wget https://raw.githubusercontent.com/LineageOS/android_system_tools_mkbootimg/lineage-18.1/mkbootimg.py -O /usr/local/bin/mkbootimg
        sudo chmod +x /usr/local/bin/mkbootimg
        
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Clone source code
      working-directory: /workdir
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Load custom feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt && $GITHUB_WORKSPACE/$DIY_P1_SH && ./scripts/feeds update -a && ./scripts/feeds install -a

    - name: Load custom configuration
      run: |
        [ -e files ] && cp -r files openwrt/files
        [ -e $CONFIG_FILE ] && cp $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt && $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: Download package
      run: cd openwrt && make defconfig && make download -j8

    - name: Compile the firmware
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        # å…è®¸æ‰“åŒ…é˜¶æ®µæŠ¥é”™ï¼Œæˆ‘ä»¬å°†æ‰§è¡Œæ‰‹åŠ¨ç¼åˆ
        make -j$(nproc) || echo "Compilation finished with packaging errors. Proceeding to manual stitch..."

    # ==============================================================================
    # ğŸ—ï¸ ç‰©ç†é•œåƒç²¾å‡†ç¼åˆ (V5.0 - 0åˆ°1çªç ´ç‰ˆ)
    # ==============================================================================
    - name: Final Image Stitching
      if: (!cancelled())
      run: |
        cd openwrt
        mkdir -p output
        
        echo ">>> Locating OpenWrt Build Artifacts..."
        ZIMAGE=$(find build_dir/target-arm_*/ -name zImage | head -n 1)
        
        # æ‰‹åŠ¨ç¼–è¯‘è®¾å¤‡æ ‘ï¼Œç¡®ä¿ Model åä¸º Tronlong TLT113-MiniEVM (OpenWrt)
        if [ -f "files/sun8i-t113-tronlong-minievm.dts" ]; then
            echo "Compiling OpenWrt Custom DTS..."
            dtc -I dts -O dtb -o output/sun8i-t113-tronlong-minievm.dtb files/sun8i-t113-tronlong-minievm.dts
            DTB="output/sun8i-t113-tronlong-minievm.dtb"
        else
            DTB=$(find build_dir/target-arm_*/ -name "sun8i-t113-tronlong-minievm.dtb" | head -n 1)
        fi
        
        ROOTFS=$(find bin/targets/sunxi/cortexa7/ -name "*rootfs.ext4" | head -n 1)
        [ -z "$ROOTFS" ] && ROOTFS=$(find build_dir/target-arm_*/ -name "root.ext4" | head -n 1)

        if [ -z "$ZIMAGE" ] || [ -z "$ROOTFS" ]; then
            echo "âŒ ERROR: Kernel or Rootfs not found!"
            exit 1
        fi

        # 4. å°è£… Android boot.img
        # ä½¿ç”¨ --header_version 2 å¼ºåˆ¶åŒ…å« DTB å—ï¼Œè§£å†³ 6.12 å†…æ ¸æ‰¾ä¸åˆ°è®¾å¤‡æ ‘é—®é¢˜
        # --base 0x45000000 ç¡®ä¿ U-Boot bootm æ ¡éªŒä¸€è‡´æ€§
        python3 /usr/local/bin/mkbootimg --kernel "$ZIMAGE" \
                  --ramdisk /dev/null \
                  --dtb "$DTB" \
                  --header_version 2 \
                  --base 0x45000000 \
                  --kernel_offset 0x00000000 \
                  --ramdisk_offset 0x01000000 \
                  --tags_offset 0x00000100 \
                  --pagesize 2048 \
                  --cmdline "console=ttyS0,115200 root=/dev/mmcblk1p5 rootwait panic=10 earlycon=uart8250,mmio32,0x02500000 clk_ignore_unused" \
                  -o output/boot.img

        # 5. å‡†å¤‡ 600MB RAW é•œåƒæ–‡ä»¶
        RAW_IMG="output/T113-OpenWrt-SD-Final.img"
        dd if=/dev/zero of=$RAW_IMG bs=1M count=600

        # 6. ç²¾å‡†ç‰©ç†æ³¨å…¥ (é€‚é…è§£å‰–å‡ºçš„å®˜æ–¹åç§»é‡)
        echo ">>> Injecting Components to SD Image..."
        
        # A. TOC0 (sboot) -> åç§» 8KB (Sector 16)
        if [ -f "files/sboot.bin" ]; then
            dd if=files/sboot.bin of=$RAW_IMG bs=512 seek=16 conv=notrunc
        fi
        
        # B. TOC1 (boot_package) -> åç§» 128KB (Sector 256)
        if [ -f "files/boot_package.fex" ]; then
            dd if=files/boot_package.fex of=$RAW_IMG bs=512 seek=256 conv=notrunc
        fi

        # C. Part 4: Boot åˆ†åŒº (OpenWrt boot.img) -> å®˜æ–¹åç§» 112262 æ‰‡åŒº
        dd if=output/boot.img of=$RAW_IMG bs=512 seek=112262 conv=notrunc

        # D. Part 5: Rootfs åˆ†åŒº (OpenWrt Rootfs) -> å®˜æ–¹åç§» 147462 æ‰‡åŒº
        dd if="$ROOTFS" of=$RAW_IMG bs=512 seek=147462 conv=notrunc

        # 7. åŒæ­¥ GPT åˆ†åŒºè¡¨ (ä¸¥æ ¼å¯¹é½å®˜æ–¹ Start LBA)
        echo ">>> Synchronizing GPT Partition Table..."
        sgdisk -o $RAW_IMG
        sgdisk -a 1 -n 4:112262:147461 -c 4:"boot" -t 4:8300 $RAW_IMG
        sgdisk -a 1 -n 5:147462:1100000 -c 5:"rootfs" -t 5:8300 $RAW_IMG

        # 8. æ³¨å…¥å®˜æ–¹â€œå¯åŠ¨å¡â€å¿…å¤‡æš—å· AUDISK (ä½äºç£ç›˜æœ«å°¾)
        echo -n "AUDISK" | dd of=$RAW_IMG bs=1 seek=$((600*1024*1024 - 1024)) conv=notrunc

        echo "âœ… DONE: All-in-one image generated successfully."

    - name: Upload Artifacts
      uses: actions/upload-artifact@main
      if: (!cancelled())
      with:
        name: T113_OpenWrt_Final_Image
        path: |
          openwrt/output/*.img
          openwrt/output/boot.img
