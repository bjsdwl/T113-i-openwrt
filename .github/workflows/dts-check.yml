name: Fast DTS Syntax Check

on:
  push:
    paths:
      - 'files/**'
  workflow_dispatch:

jobs:
  check-dts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y device-tree-compiler gcc

      - name: Setup Environment
        run: |
          # 只需要把文件拿出来
          cp files/* .
          
          # 创建 GPIO 和 LED 的简单定义（这两个通常在 board dts 引用）
          mkdir -p include/dt-bindings/gpio
          mkdir -p include/dt-bindings/leds
          
          echo "#define GPIO_ACTIVE_HIGH 0" > include/dt-bindings/gpio/gpio.h
          echo "#define GPIO_ACTIVE_LOW 1" >> include/dt-bindings/gpio/gpio.h
          echo "#define LED_COLOR_ID_GREEN 2" > include/dt-bindings/leds/common.h
          echo "#define LED_FUNCTION_STATUS \"status\"" >> include/dt-bindings/leds/common.h

      - name: Run Syntax Check
        run: |
          echo "Processing DTS..."
          # 预处理：现在文件自带宏定义，不需要依赖假头文件了
          if ! cpp -nostdinc -I include -undef -x assembler-with-cpp sun8i-t113-tronlong-minievm.dts > temp.dts; then
            echo "❌ CPP Pre-processing failed!"
            exit 1
          fi
          
          echo "Compiling DTS..."
          if ! dtc -I dts -O dtb -o test.dtb -Wno-unit_address_vs_reg -Wno-simple_bus_reg -Wno-graph_child_address temp.dts; then
            echo "❌ DTC Syntax Error found!"
            exit 1
          fi
          
          echo "✅ SUCCESS: DTS Syntax is Valid!"
