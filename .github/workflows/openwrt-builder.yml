name: OpenWrt Builder

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev gawk git gettext swig python3-distutils python3-setuptools python3-dev u-boot-tools device-tree-compiler qemu-utils wget
        
        # [‰øÆÂ§ç] ‰ΩøÁî® LineageOS Á®≥ÂÆöÈïúÂÉèÊ∫ê‰∏ãËΩΩ mkbootimg.py
        sudo wget https://raw.githubusercontent.com/LineageOS/android_system_tools_mkbootimg/lineage-18.1/mkbootimg.py -O /usr/local/bin/mkbootimg
        sudo chmod +x /usr/local/bin/mkbootimg
        
        # È™åËØÅÂ∑•ÂÖ∑ÊòØÂê¶ÂèØÁî®
        python3 /usr/local/bin/mkbootimg --help

    - name: Clone source code
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf $GITHUB_WORKSPACE/openwrt /workdir

    - name: Load custom feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt && $GITHUB_WORKSPACE/$DIY_P1_SH && ./scripts/feeds update -a && ./scripts/feeds install -a

    - name: Load custom configuration
      run: |
        [ -e files ] && cp -r files openwrt/files
        [ -e $CONFIG_FILE ] && cp $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt && $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: Download package
      run: cd openwrt && make defconfig && make download -j8

    - name: Compile the firmware
      run: cd openwrt && make -j$(nproc) || make -j1 V=s
# ==============================================================================
    # üèóÔ∏è Áâ©ÁêÜÈïúÂÉèÁ°¨ÁºùÂêà (Â¢ûÂº∫ÂÆπÈîôÁâà)
    # ==============================================================================
    - name: Final Image Stitching
      if: (!cancelled())
      run: |
        cd openwrt
        mkdir -p output
        
        echo ">>> Debugging: Searching for build artifacts..."
        # 1. ÂÖ®Â±ÄÊêúÁ¥¢ zImage (‰∏çÂÜç‰æùËµñÁâπÂÆöË∑ØÂæÑ)
        ZIMAGE=$(find . -type f -name "zImage" ! -name "*initramfs*" | head -n 1)
        
        # 2. ÂÖ®Â±ÄÊêúÁ¥¢ DTB
        DTB=$(find . -type f -name "sun8i-t113-tronlong-minievm.dtb" | head -n 1)
        
        # 3. ÂÖ®Â±ÄÊêúÁ¥¢ Rootfs
        ROOTFS=$(find . -type f -name "*rootfs.ext4" | head -n 1)

        echo "---------------------------------------------"
        echo "Captured Kernel: $ZIMAGE"
        echo "Captured DTB:    $DTB"
        echo "Captured Rootfs: $ROOTFS"
        echo "---------------------------------------------"

        # 4. ÂÖ≥ÈîÆÊ£ÄÊü•ÔºöÂ¶ÇÊûúÊâæ‰∏çÂà∞ÂÜÖÊ†∏ÔºåËØ¥ÊòéÁºñËØëÈò∂ÊÆµÂÖ∂ÂÆûÂ§±Ë¥•‰∫Ü
        if [ -z "$ZIMAGE" ]; then
            echo "‚ùå Error: zImage not found! Compilation likely failed."
            echo ">>> Listing build_dir for debugging:"
            ls -d build_dir/* || echo "build_dir not found"
            exit 1
        fi

        if [ -z "$DTB" ]; then
            echo "‚ùå Error: DTB file not found! Check if device tree compiled."
            exit 1
        fi

        # 5. Â∞ÅË£Ö Android boot.img
        echo ">>> Generating boot.img..."
        python3 /usr/local/bin/mkbootimg --kernel "$ZIMAGE" \
                  --ramdisk /dev/null \
                  --dtb "$DTB" \
                  --base 0x40000000 \
                  --kernel_offset 0x00008000 \
                  --ramdisk_offset 0x01000000 \
                  --tags_offset 0x00000100 \
                  --pagesize 2048 \
                  --cmdline "console=ttyS0,115200 root=/dev/mmcblk0p5 rootwait panic=10" \
                  -o output/boot.img

        # 6. ÁºùÂêà RAW ÈïúÂÉè
        echo ">>> Stitching Final SD Card Image..."
        RAW_IMG="output/T113-OpenWrt-SD-Stitched.img"
        dd if=/dev/zero of=$RAW_IMG bs=1M count=600 status=none

        # A. TOC0 (sboot) -> ÂÅèÁßª 8KB (Sector 16)
        if [ -f "files/sboot.bin" ]; then
            dd if=files/sboot.bin of=$RAW_IMG bs=512 seek=16 conv=notrunc
        else
            echo "‚ö†Ô∏è Warning: sboot.bin not found in files/! Image will not boot."
        fi

        # B. TOC1 (boot_package) -> ÂÅèÁßª 128KB (Sector 256)
        if [ -f "files/boot_package.fex" ]; then
            dd if=files/boot_package.fex of=$RAW_IMG bs=512 seek=256 conv=notrunc
        else
            echo "‚ö†Ô∏è Warning: boot_package.fex not found in files/!"
        fi

        # C. P4 (boot.img) -> ÂÅèÁßª 16MB (Sector 32768)
        dd if=output/boot.img of=$RAW_IMG bs=512 seek=32768 conv=notrunc

        # D. P5 (rootfs.ext4) -> ÂÅèÁßª 64MB (Sector 131072)
        if [ -n "$ROOTFS" ]; then
            dd if="$ROOTFS" of=$RAW_IMG bs=512 seek=131072 conv=notrunc
        else
             echo "‚ö†Ô∏è Warning: Rootfs not found, skipping P5 write."
        fi

        echo "‚úÖ Success! Final Image created at: $RAW_IMG"
        ls -lh output/
